<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­éŸ³æƒ…æ„Ÿè¯†åˆ«ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="./css/style.css">
  <style>
    /* åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ ·å¼ */
    body { font-family: Arial, sans-serif; margin: 20px; }
    .loading-error { color: red; padding: 20px; background: #ffe6e6; border: 2px solid red; border-radius: 8px; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="bg-decoration"></div>
    
    <div class="container">
      <header class="app-header">
        <div class="header-content">
          <h1>
            <span class="icon">ğŸ¤</span>
            è¯­éŸ³æƒ…æ„Ÿè¯†åˆ«ç³»ç»Ÿ
          </h1>
          <p class="subtitle">å®æ—¶è¯­éŸ³è½¬æ–‡å­— Â· æ™ºèƒ½æƒ…ç»ªåˆ†æ Â· å¤šç»´åº¦æƒ…æ„Ÿæ£€æµ‹</p>
        </div>
      </header>

      <!-- æ¨¡å¼é€‰æ‹© -->
      <div class="mode-selector">
        <label class="mode-option">
          <input type="radio" name="mode" value="sensevoice" checked>
          <span class="mode-card">
            <div class="mode-icon">âœ¨</div>
            <div class="mode-content">
              <strong>SenseVoice</strong>
              <small>ä¸€ç«™å¼åˆ†æï¼šASR + 7ç±»æƒ…æ„Ÿ + äº‹ä»¶æ£€æµ‹</small>
            </div>
          </span>
        </label>
        <label class="mode-option">
          <input type="radio" name="mode" value="paraformer">
          <span class="mode-card">
            <div class="mode-icon">ğŸ¯</div>
            <div class="mode-content">
              <strong>Paraformer + SpeechBrain</strong>
              <small>ä¸­æ–‡ASR + 4ç±»æƒ…æ„Ÿæ¦‚ç‡åˆ†æ</small>
            </div>
          </span>
        </label>
      </div>

      <!-- è¿æ¥æ§åˆ¶åŒº -->
      <div class="connect-section">
        <button id="btn-connect" class="btn-connect">
          <span class="btn-icon">ğŸ”Œ</span>
          <span class="btn-text">è¿æ¥æœåŠ¡å™¨</span>
        </button>
        <div id="connect-progress" class="connect-progress hidden">
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <div id="progress-text" class="progress-text">æ­£åœ¨è¿æ¥...</div>
        </div>
      </div>

      <!-- ä¸»æ§åˆ¶åŒº -->
      <div class="main-controls">
        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="status-card">
          <div class="status-header">
            <span id="connection-status" class="status-dot disconnected"></span>
            <span id="status-text" class="status-text">æœªè¿æ¥</span>
            <span id="timer" class="timer"></span>
          </div>
          
          <!-- æ³¢å½¢å¯è§†åŒ– -->
          <div class="waveform-container">
            <canvas id="waveform" width="600" height="120"></canvas>
            <div class="waveform-overlay">
              <div class="waveform-label">å®æ—¶éŸ³é¢‘æ³¢å½¢</div>
            </div>
          </div>
        </div>

        <!-- å½•éŸ³æ§åˆ¶ -->
        <div class="record-controls">
          <button id="btn-record" class="btn-record" disabled>
            <span class="btn-icon">ğŸ™ï¸</span>
            <span class="btn-text">å¼€å§‹å½•éŸ³</span>
          </button>
          <button id="btn-stop" class="btn-stop" disabled>
            <span class="btn-icon">â¹ï¸</span>
            <span class="btn-text">åœæ­¢</span>
          </button>
        </div>
        <div id="record-hint" class="record-hint">
          <span class="hint-icon">ğŸ’¡</span>
          <span class="hint-text">è¯·å…ˆè¿æ¥æœåŠ¡å™¨åå†å¼€å§‹å½•éŸ³</span>
        </div>
      </div>

      <!-- å®æ—¶è½¬å½•æ˜¾ç¤º -->
      <div id="live-transcript-panel" class="live-transcript-panel hidden">
        <div class="live-transcript-header">
          <span class="live-icon">ğŸ¤</span>
          <h3>å®æ—¶è½¬å½•</h3>
        </div>
        <div class="live-transcript-content">
          <p id="live-transcript-text" class="live-transcript-text">æ­£åœ¨è¯†åˆ«...</p>
        </div>
      </div>

      <!-- ç»“æœå±•ç¤ºåŒº -->
      <div id="result-panel" class="result-panel hidden">
        <div class="result-header">
          <h2>
            <span class="result-icon">ğŸ“Š</span>
            åˆ†æç»“æœ
          </h2>
          <button id="btn-clear-result" class="btn-clear" title="æ¸…é™¤ç»“æœ">âœ•</button>
        </div>

        <div class="result-content">
          <!-- è½¬å½•æ–‡æœ¬å¡ç‰‡ -->
          <div class="result-card transcript-card">
            <div class="card-header">
              <span class="card-icon">ğŸ“</span>
              <h3>è½¬å½•æ–‡æœ¬</h3>
            </div>
            <div class="card-body">
              <p id="result-transcript" class="transcript">ç­‰å¾…åˆ†æ...</p>
              <p id="result-language" class="meta"></p>
            </div>
          </div>

          <!-- æƒ…æ„Ÿåˆ†æå¡ç‰‡ -->
          <div class="result-card emotion-card">
            <div class="card-header">
              <span class="card-icon">ğŸ’­</span>
              <h3>æƒ…æ„Ÿåˆ†æ</h3>
            </div>
            <div class="card-body">
              <div id="result-emotion" class="emotion-display"></div>
            </div>
          </div>

          <!-- äº‹ä»¶æ£€æµ‹å¡ç‰‡ï¼ˆä»… SenseVoiceï¼‰ -->
          <div id="event-section" class="result-card event-card hidden">
            <div class="card-header">
              <span class="card-icon">ğŸ””</span>
              <h3>è¯­éŸ³äº‹ä»¶</h3>
            </div>
            <div class="card-body">
              <div id="result-event" class="event-display"></div>
            </div>
          </div>

          <!-- éŸ³é¢‘ç‰¹å¾å¡ç‰‡ -->
          <div class="result-card features-card">
            <div class="card-header">
              <span class="card-icon">ğŸ“ˆ</span>
              <h3>éŸ³é¢‘ç‰¹å¾</h3>
            </div>
            <div class="card-body">
              <div id="result-audio-features" class="features-display"></div>
            </div>
          </div>

          <!-- æ–‡æœ¬æƒ…æ„Ÿå¡ç‰‡ -->
          <div id="sentiment-section" class="result-card sentiment-card hidden">
            <div class="card-header">
              <span class="card-icon">ğŸ’¬</span>
              <h3>æ–‡æœ¬æƒ…æ„Ÿåˆ†æ</h3>
            </div>
            <div class="card-body">
              <div id="result-text-sentiment" class="sentiment-display"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- å†å²è®°å½• -->
      <div class="history-section">
        <div class="history-header">
          <h3>
            <span class="history-icon">ğŸ“š</span>
            å†å²è®°å½•
          </h3>
          <button id="btn-clear-history" class="btn-clear-small" title="æ¸…ç©ºå†å²">æ¸…ç©º</button>
        </div>
        <div id="history-list" class="history-list">
          <div class="history-empty">æš‚æ— å†å²è®°å½•</div>
        </div>
      </div>

      <!-- é”™è¯¯æç¤º -->
      <div id="error-panel" class="error-panel hidden">
        <div class="error-icon">âš ï¸</div>
        <p id="error-message"></p>
        <button id="btn-dismiss-error" class="btn-dismiss">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    // æ£€æŸ¥èµ„æºåŠ è½½
    window.addEventListener('error', function(e) {
      console.error('èµ„æºåŠ è½½å¤±è´¥:', e.filename, e.message, e);
      if (e.target && e.target.tagName) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'loading-error';
        errorDiv.innerHTML = `<strong>èµ„æºåŠ è½½å¤±è´¥:</strong> ${e.target.src || e.target.href || e.filename}<br>é”™è¯¯: ${e.message}<br>è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’ŒæœåŠ¡å™¨é…ç½®`;
        document.body.insertBefore(errorDiv, document.body.firstChild);
      }
    }, true);
    
    // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼ˆå»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½ï¼‰
    function checkDOMElements() {
      const requiredIds = [
        'btn-connect', 'btn-record', 'btn-stop',
        'connection-status', 'status-text', 'waveform', 'result-panel'
      ];
      const missing = [];
      
      requiredIds.forEach(id => {
        if (!document.getElementById(id)) {
          missing.push(id);
        }
      });
      
      if (missing.length > 0) {
        console.error('ç¼ºå°‘DOMå…ƒç´ :', missing);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'loading-error';
        errorDiv.style.position = 'fixed';
        errorDiv.style.top = '0';
        errorDiv.style.left = '0';
        errorDiv.style.right = '0';
        errorDiv.style.zIndex = '10000';
        errorDiv.innerHTML = `<strong>é¡µé¢åŠ è½½é”™è¯¯</strong><br>ç¼ºå°‘ä»¥ä¸‹å…ƒç´ : ${missing.join(', ')}<br>è¯·æ£€æŸ¥HTMLæ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½`;
        document.body.insertBefore(errorDiv, document.body.firstChild);
        return false;
      }
      return true;
    }
    
    // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†æ£€æŸ¥
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoadedäº‹ä»¶è§¦å‘');
        setTimeout(() => {
          if (checkDOMElements()) {
            console.log('âœ“ æ‰€æœ‰å¿…éœ€çš„DOMå…ƒç´ éƒ½å­˜åœ¨');
          }
        }, 100);
      });
    } else {
      // DOMå·²ç»åŠ è½½å®Œæˆ
      setTimeout(() => {
        if (checkDOMElements()) {
          console.log('âœ“ æ‰€æœ‰å¿…éœ€çš„DOMå…ƒç´ éƒ½å­˜åœ¨');
        }
      }, 100);
    }
  </script>
  <script src="./js/audio.js"></script>
  <script src="./js/websocket.js"></script>
  <script src="./js/ui.js"></script>
  <script src="./js/app.js"></script>
</body>
</html>
